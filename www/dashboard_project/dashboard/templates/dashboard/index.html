<!DOCTYPE html>
{% load static %}
<html>
  <head>
    <title>Julia Ecosystem Status</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="{% static "css/bootstrap.min.css" %}" rel="stylesheet" media="screen">
    <link href="{% static "css/jquery.jqplot.min.css" %}" rel="stylesheet" media="screen">
    <style>
      .blankcell, .cell{
        padding: 5px 5px 5px 5px;
        margin: 10px 10px 10px 10px;
      }

    	.cell {
    		background-color: #eee;
    		border: 1px solid #999;
    	}

      .codespeed_cell {
        padding: 2px 5px 2px 5px;
        margin: 2px 3px 2px 3px;
        border: 1px solid #8d8d8d;
        background-color: #d8d8d8;
      }

      .resizing, .code {
        border: 1px solid #8d8d8d;
        padding: 0px 2px 0px 2px;
        background-color: #ccc;
      }

      .fresh {
        color: green;
      }

      .stale {
        color: orange;
      }

      .frozen {
        color: red;
        font-weight: bold;
      }

      .graph {
        height:200px;
        width: 100%;
      }

      .bordered {
        border: 1px solid #8d8d8d;
        margin: 2px 2px 2px 2px;
        padding: 0px 1px 0px 1px;
      }

      /* shamelessly stolen from iaindunning.com */
      .using_fail   { background-color: #FF4444; }
      .using_pass   { background-color: #AAAAFF; }
      .full_fail    { background-color: #FF9922; }
      .full_pass    { background-color: #55FF55; }
      .not_possible { background-color: #AFAFAF; }

      .cell_using_fail   { background-color: #ffcccc; }
      .cell_using_pass   { background-color: #ddddff; }
      .cell_full_fail    { background-color: #ffddcc; }
      .cell_full_pass    { background-color: #ddffdd; }
      .cell_not_possible { background-color: #eee; }

      /* I don't like that dashed underline */
      abbr[title] {
        border-bottom: 0px;
      }
  	</style>
    <script src="{% static "js/jquery.min.js" %}" type="text/javascript"></script>
  	<script src="{% static "js/bootstrap.min.js" %}" type="text/javascript"></script>
  	<script src="{% static "js/jquery.timeago.js" %}" type="text/javascript"></script>
    <script src="{% static "js/jquery.jqplot.min.js" %}" type="text/javascript"></script>
    <script src="{% static "js/jqplot/jqplot.pointLabels.min.js" %}" type="text/javascript"></script>
    <script src="{% static "js/jqplot/jqplot.barRenderer.min.js" %}" type="text/javascript"></script>
    <script src="{% static "js/jqplot/jqplot.categoryAxisRenderer.min.js" %}" type="text/javascript"></script>

  	<script type="text/javascript">
      // This is used for the resizing code below so that we know when to redraw
      // Without this, we redraw many times per second while resizing the window
      var resizeHandles = {}
      var plotHandles = {}

  		$(document).ready(function() {
        // We're going to start a timer that will update the data every minute
        update();
        setInterval( update, 60*1000 )

        // Also register a resize handler that will stop our graphs from trying to redraw eagerly
        $(window).bind('resize',function(event, ui) {
          // For each graph in the DOM
          $('div.graph').each( function( i ) {
            var id = $(this).attr('id')

            // If we're already resizing, clear that timeout
            if( id in resizeHandles )
              clearTimeout( id )
            
            // Empty ourselves and add the class "resizing"
            $(this).empty().addClass('resizing')

            // 50 ms from here, replot and remove the "resizing" class
            resizeHandles[id] = setTimeout( function() {
              plotHandles[id].replot( {resetAxes: true })
              $('div#'+id).removeClass('resizing')
            }, 50)
          })
        })
  		});

      // Santize a DOM selector so that we aren't using invalid characters
      function sanitize(selector) {
        if( selector )
          return selector.replace(/[ +\/.]/g,'_')
        return selector
      }

      // Converts the data we've received from the server to native Javascript objects
      // Currently the only thing needing done is str -> Date
      function convert_data(data) {
        for( key in data )
          data[key]['time'] = new Date(data[key]['time'])
        return data
      }

      // Given a set dates in bins, histogram data into the nearest bin
      function histogram_data(data, bins) {
        pass = new Array(bins.length)
        fail = new Array(bins.length)
        for( i = 0; i < bins.length; ++i ) {
          pass[i] = 0;
          fail[i] = 0;
        }

        for( key in data ) {
          // Get the time for this particular build
          t = data[key]['time']

          // Find closest bin time
          min_idx = 0;
          for( j=1; j<bins.length; ++j ) {
            if( Math.abs(t - bins[min_idx]) > Math.abs(t - bins[j]) )
              min_idx = j;
          }

          // Increment respective output bin
          if( data[key]['result'] == 'OK' )
            pass[min_idx]++;
          else
            fail[min_idx]++;
        }
        return [pass, fail]
      }

      // Sorts an array of objects with 'time' keys
      function sort_by_date(data) {
        data.sort(function(a,b){
          if( a['time'] < b['time'] )
            return -1
          if( a['time'] > b['time'] )
            return 1
          return 0
        })
        return data;
      }

      // Given the start and end date, construct a linear representation of dates
      function build_xaxis(start, end, num) {
        // Default to a certain number of items between start and end (inclusive)
        num = typeof num !== 'undefined' ? num : 8

        xaxis = new Array(num)
        step = ((end - start)/(num-1))/(24*60*60*1000)

        // My naive attempt at snapping to a grid so we don't magically "lose" a day every now and then
        if( Math.abs(Math.round(step) - step) < .25 )
          step = Math.round(step)

        // Evenly space each tick
        for( i = num; i>=0; --i ) {
          xaxis[num-i] = new Date(end.getTime())
          xaxis[num-i].setDate(end.getDate() - step*i)
        }
        return xaxis;
      }

      // Convert a date to "mm/dd" notation
      function datestr(x) {
        return (x.getMonth()+1) + '/' + x.getDate()
      }

      var dataDebug = {}

      // Draw a graph for the Travis Julia tests to illustrate passing/failing tests
      function update_travis_graph( data, id ) {
        if( data.length == 0 )
          return;

        // Cleanup our data
        data = convert_data(data)
        // First, sort the data by date
        data = sort_by_date(data)

        // Decide what our bins will be; if we have "enough" datapoints within the last min_time days,
        // plot only min_time days.  If not, we will plot back far enough until we have "enough"
        var enough = 40
        var min_time = 8

        // Find how far back we need to go to get min_time worth
        var i = Math.max( 0, data.length-2)
        var now = data[data.length-1]['time']
        var enough_days = min_time*24*60*60*1000
        while( i > 0 && (now - data[i]['time']) < enough_days ) {
          i--
        }

        var start = null;
        var end = data[data.length-1]['time']

        // Construct xaxis according to what data we have
        if( i <= 0 || (data.length - i) >= enough ) {
          // If we ran out of builds, or we have enough within ten days, use either
          // the start of the data we'll plot, or enough_days, whichever is more time!
          start = new Date(Math.min( end.getTime() - enough_days, data[i]['time'].getTime() ))
        } else {
          // Otherwise, use a longer window until we have enough (if possible)
          i = Math.max(0, data.length - enough)

          start = new Date(data[i]['time'])
        }
        
        // And this is our x-axis.  We'll also create a string representation
        var xaxis = build_xaxis(start, end)
        var xaxis_str = new Array(xaxis.length)

        // Check the width of bins.  If greater than 2 days, we'll give date ranges on the axis
        if( (xaxis[1] - xaxis[0]) > 2*24*60*60*1000 ) {
          var width = (xaxis[1] - xaxis[0])/2
          for( var j=0; j<xaxis.length; ++j ) {
            var x_start = new Date(xaxis[j].getTime() - width)
            var x_end = new Date(xaxis[j].getTime() + width)
            xaxis_str[j] = '(' + datestr(x_start) + ' - ' + datestr(x_end) + ')'
          }
        } else {
          for( var j=0; j<xaxis.length; ++j )
            xaxis_str[j] = datestr(xaxis[j])
        }

        // Now, histogram the data according to xaxis
        plot_series = histogram_data( data.slice(i,data.length), xaxis )


        // Finally, plot it all out!
        $('#'+id).empty()
        plotHandles[id] = $.jqplot(id, plot_series, {
          seriesDefaults: {
            renderer: $.jqplot.BarRenderer,
            rendererOptions: {
              barPadding: 4,

            }
          },

          seriesColors: ["#33bb33", "#ee0000"],

          series:[
            {label: 'Pass'},
            {label: 'Fail'},
          ],

          legend: {
            show: true,
          },

          axes: {
            xaxis: {
              renderer: $.jqplot.CategoryAxisRenderer,
              ticks: xaxis_str,
            },
          },
        })
      }


      // Download new data from the site, write it out to the DOM
      function update() {
        // Start with nightly builds
        $.ajax('get/nightly', {success:function( data ) {
          // We're given a dict indexed by target
          for( target in data ) {
            id = 'nightly-'+sanitize(target)

            // Have we already added this particular target?
            var abbr = $('#container_nightly').find('abbr#'+id)
            if( abbr.length != 0 ) {
              // If so, just update the title and url
              $(abbr).attr('title', data[target]['time'])
              $('#container_nightly').find('a#'+id)
            } else {
              // Otherwise, create the whole DOM mess
              template =  '<div class="cell row">'
              template +=     '<div style="padding: 0px 0px 0px 0px" class="col-xs-10">'
              template +=     target + ' nightly last built: '
              template +=     '<abbr id="'+id+'" class="timeago" title="' + data[target]['time'] + '">'
              template +=       $.timeago.parse(data[target]['time']).toLocaleString()
              template +=     '</abbr>'
              template +=     '</div>'
              template +=     '<div style="padding: 0px 0px 0px 0px" class="col-xs-2 text-right">'
              template +=     '<a id="'+id+'" href="'+data[target]['url']+'" target="_blank">download</a>'
              template +=     '</div>'
              template += '</div>'
              $('#container_nightly').append(template)
            }
          }

          // Any <abbr> tags with .timeago applied to it will get automagically updated!
          $('abbr.timeago').timeago();
        }})


        // Then, move on to travis builds
        $.ajax('get/travis', {success:function( data ) {
          // We're given a dict indexed by branch
          for( branch in data ) {
            // Gotta sanitize out naughty characters
            id = 'travis-'+sanitize(branch)

            // Do we already have a graph built for this branch?
            var graph = $('#container_travis').find('div#'+id)
            if( graph.length == 0 ) {
              // Otherwise, build the DOM stuffages
              template =  '<div class="cell" id="cell-'+id+'">'
              template +=   '<span class="code">' + branch + '</span> test history:'
              template +=   '<a style="float: right" href="http://github.com/JuliaLang/julia/tree/'+branch+'">GitHub</a>'
              template +=   '<div class="graph" id="'+id+'"></div>'
              template += '</div>'
              $('#container_travis').append(template)
            }
            // Now, update the graph for this branch
            update_travis_graph(data[branch], id)
          }
        }})


        // Next, let's do the codespeed builds
        $.ajax('get/codespeed_envs', {success:function(envs) {
          $.ajax('get/codespeed', {success:function(blas_data) {
            // I'm not in love with this approach since we build everything every time, as opposed
            // to the approach in the nightly builds where we selectively update, etc....
            // But I'm willing to live with it for now
            template = ''
            for( name in envs ) {
              if( Object.keys(blas_data[name]).length > 0 ) {
                template += '<div class="cell row">'
                template += '<div class="col-sm-2">'
                template += '<div style="padding: 2px 0px 2px 0px; margin: 2px 0px 2px 0px;">'
                template += '<b title="'+envs[name]+'">' + name + ':</b> '
                template += '</div>'
                template += '</div>'
                //template += '<div style="display:block-inline" class="row">'
                for( blas in blas_data[name] ) {
                  id = 'codespeed-'+sanitize(name+'-'+blas)
                  template += '<div class="codespeed_cell col-sm-3">'
                  template +=   blas + ': '
                  template +=   '<abbr id="'+id+'" class="timeago" title="'+blas_data[name][blas]['time']+'">'
                  template +=     $.timeago.parse(blas_data[name][blas]['time']).toLocaleString()
                  template +=     ' '+blas_data[name][blas]['commit']
                  template +=   '</abbr>'
                  template += '</div>'
                }
                //template += '</div>'
                template += '</div>'
              }
            }

            $('#container_codespeed').html(template)

            // Any <abbr> tags with .timeago applied to it will get automagically updated!
            $('abbr.timeago').timeago();
          }})
        }})

        // Finally, let's close out with Package statii
        $.ajax('get/package', {success:function( data ) {
          // We're given a dict indexed by name, sort ignoring case
          names = Object.keys(data).sort(function( a, b) {
            return a.toLowerCase().localeCompare(b.toLowerCase());
          })
          
          for( idx in names ) {
            d = data[names[idx]]
            id = 'package-'+sanitize(names[idx])

            // Have we already added this particular package?
            var div = $('#container_package').find('#'+id)

            // If not, barf out the DOM elements we need
            if( div.length == 0 ) {
              template =  '<div id="'+id+'" class="cell">'
              template += '  <div style="margin-left: -12px; margin-right:0px" class="row">'
              template += '    <div class="pkg-name col-xs-2"></div>'
              template += '  </div>'
              template += '  <div style="margin-left: 0px; margin-right:0px" class="row">'
              template += '    <div class="pkg-details col-xs-7 bordered"></div>'
              template += '    <div class="pkg-license col-xs-1 bordered"></div>'
              template += '    <div class="pkg-pkgreq col-xs-1 bordered"></div>'
              template += '    <div class="pkg-metareq col-xs-1 bordered"></div>'
              template += '    <div class="pkg-travis col-xs-1 bordered"></div>'
              template += '  </div>'
              template += '</div>'

              // Append that template to the container, then update our div element accordingly
              $('#container_package').append(template)
              div = $('#container_package').find('div#'+id)
            }

            // Now, update the above div with the new information stored in data
            pkgname = $(div).find('.pkg-name')
            pkgname.html('<a href="'+d['url']+'">'+names[idx]+'</a>')
            $(div).removeClass("cell_full_pass cell_full_fail cell_using_pass cell_using_fail")
            $(div).addClass('cell_'+d['status'])

            details = $(div).find('.pkg-details')
            details.html(d['details'])
            details.removeClass("full_pass full_fail using_pass using_fail")
            details.addClass(d['status'])

            license = $(div).find('.pkg-license')
            license.html('<a href="'+d['url']+'/blob/master/LICENSE.md">'+d['license']+'</a>')
            license.removeClass("full_pass full_fail")
            if( d['license'] != "Unknown" )
              license.addClass("full_pass")
            else
              license.addClass("full_fail")

            pkgreq = $(div).find('.pkg-pkgreq')
            pkgreq.removeClass("full_pass full_fail")
            if( d['pkgreq'] ) {
              pkgreq.addClass("full_pass")
              pkgreq.html('<a href="'+d['url']+'/blob/master/REQUIRE">Pkg</a>')
            } else {
              pkgreq.addClass("full_fail")
              pkgreq.html('<a href="'+d['url']+'/blob/master">Pkg</a>')
            }

            metareq = $(div).find('.pkg-metareq')
            metareq.removeClass("full_pass full_fail")
            if( d['metareq'] ) {
              metareq.addClass("full_pass")
              metareq.html('<a href="https://github.com/JuliaLang/METADATA.jl/blob/metadata-v2/'+names[idx]+'/versions/'+d['version']+'/requires">Meta</a>')
            } else {
              metareq.addClass("full_fail")
              metareq.html('<a href="https://github.com/JuliaLang/METADATA.jl/blob/metadata-v2/'+names[idx]+'/versions">Meta</a>')
            }

            travis = $(div).find('.pkg-travis')
            githubIndex = d['url'].indexOf("github.com/")
            travis.removeClass("full_pass full_fail")
            console.log( d['travis'] )
            console.log( githubIndex )
            if( d['travis'] && githubIndex != -1 ) {
              // Parse out the username and repo
              userAndRepo = d['url'].substring(githubIndex+11, d['url'].length )

              travis.html('<a href=https://travis-ci.org/'+userAndRepo+'>Travis</a>')
              travis.addClass("full_pass")
            } else {
              travis.addClass("full_fail")
              travis.html('Travis')
            }
          }

          // Any <abbr> tags with .timeago applied to it will get automagically updated!
          $('abbr.timeago').timeago();
        }})
      }
  	</script>
  </head>
  <body>
    <div class="container">
  		<div class="page-header">
  			<h1>Julia Ecosystem Status</h1>
  			<p class="lead">This page tracks the status of various parts of the <a href="http://julialang.org">Julia language</a> ecosystem; from nightly binary builds of Julia to automated testing of packages.</p>
  		</div>

      <h3>Nightly Builds</h3>
      <div id="container_nightly">
      </div>

      <h3><a href="http://travis-ci.org/JuliaLang/julia/builds">Travis</a> Julia tests</h3>
      <div id="container_travis">
      </div>

      <h3><a href="http://speed.julialang.org">Codespeed</a> builds</h3>
      <div id="container_codespeed">
      </div>

      <h3>Package tests</h3>
      <div id="container_package">
        <h5>Layout and color legend:</h5>
        <div  class="cell">
          <div style="margin-left: 0px; margin-right:0px" class="row">
            <div class="bordered col-sm-2">
              Package name
            </div>
            <div class="col-sm-5">
            </div>
            <div style="margin: 0px; padding: 0px 1px 0px 1px;" class="col-sm-4">
              <div class="bordered using_fail">
                `using package` failed
              </div>
              <div class="bordered full_fail">
              `using package` worked, tests failed
              </div>
              <div class="bordered using_pass">
                `using package` passed, tests missing
              </div>
              <div class="bordered full_pass">
                `using package` passed, all tests pass
              </div>
            </div>
          </div>
          <div style="margin-left: 0px; margin-right:0px" class="row">
            <div class="col-xs-7 bordered">
              Detailed Description
            </div>
            <div class="col-xs-1 bordered">
              License
            </div>
            <div class="col-xs-1 bordered">
              Pkg REQUIRE
            </div>
            <div class="col-xs-1 bordered">
              METADATA REQUIRE
            </div>
            <div class="col-xs-1 bordered">
              Travis
            </div>
          </div>
        </div>
      </div>
  	</div>
  </body>
</html>
